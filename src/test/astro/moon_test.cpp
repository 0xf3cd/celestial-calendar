#include <gtest/gtest.h>
#include "util.hpp"
#include "astro.hpp"

namespace astro::moon::test {

using namespace astro::moon::geocentric_coord;


TEST(Moon, CoordAndPpi) {
  const std::unordered_map<double, std::tuple<double, double, double, double>> dataset {
    // JDE                  Longitude in deg     Latitude in deg      Radius in km          PPI in rad
    { 2455820.8787544146, {  36.726233329779895,   3.323172151719455,   405517.1384250576,  0.015729059017928735 } },
    {  2454305.403776242, {  228.53476952571248,  -4.898482383763094,    402649.731243161,   0.01584108039265102 } },       
    { 2453630.7615909837, {   343.0133818145305,  -2.682728118171436,  360802.15515138546,  0.017678586866276418 } },       
    { 2460787.5640272405, {   314.3452325680488,  -3.523168644615433,    380300.872532407,  0.016772086266495054 } },       
    {  2453920.978856268, {  201.02573730370074, -1.9331436884333921,  400130.03411087435,  0.015940843200019608 } },       
    { 2455033.0523539423, {   95.87461078862165,  2.1875042138644933,   359055.5318601611,  0.017764593262308823 } },       
    {  2455639.162253953, {  161.99120758906975,  -4.804833995445399,  357866.65220724087,  0.017823615795964403 } },       
    { 2460553.0908111953, {  118.43798960297818,   4.853252601045634,  394761.90397688467,   0.01615763189585266 } },       
    { 2456910.9583296073, {   7.041846959694951,  1.1282296348070076,   363236.5699360123,   0.01756009259597654 } },       
    { 2456354.0557590206, {  221.43774484937796, -0.6773561466785337,   372719.8423006021,   0.01711325936434138 } },       
    { 2456262.4702930865, {   94.63018828142246,  -3.297235121702206,    404855.041253622,  0.015754784340452296 } },       
    { 2459968.3639730234, {   331.9534232156953,  -4.615340256483026,   360452.5610748505,  0.017695734682067827 } },       
    { 2455248.6117273094, {    51.1773018633265,   4.434630488622709,   385800.7365308566,  0.016532966298430228 } },       
    {  2457316.173043621, {   294.6752617743573,   4.795290266491586,   380651.2106566481,  0.016756648376509708 } },       
    { 2452115.5234712195, {  180.85351543519127,   5.208934571611883,  366864.74260398035,  0.017386411418318606 } },       
    {  2452291.998539657, {  340.90970228066413,   -5.00121628636893,   405103.2172864411,  0.015745131780450883 } },       
    { 2461056.0768461325, {   258.9820037447788,  -5.062443918225046,    403934.312838539,  0.015790698798732045 } },       
    {  2455044.746044929, {  256.98302103663036,  -3.631360754522632,  402771.55140728096,   0.01583628878220182 } },       
    { 2454494.7564110793, {  208.28090482670223,  -4.574583707646692,   402089.7557796162,    0.0158631435261455 } },       
    {  2461422.982340823, {   47.59806660964453,   5.241808616859706,  372837.88691330294,  0.017107840587759347 } },
    {  2454701.751006527, {  50.679550456501175,   5.265450936332354,   371276.7709013708,  0.017179781383094415 } },
    {  2457469.060913669, {  160.02808987984963, -1.0854447468074448,   400923.8554201004,  0.015909277979770563 } },       
    { 2456276.6501769833, {   288.7483315552447,   4.177244639004016,  361668.50401068764,  0.017636234785769294 } },       
    {  2460023.685719419, {  338.18384006737267,  -4.308720062252872,  362923.69988531014,  0.017575232396904034 } },       
    {  2456669.529024311, {   66.18028413515557, -2.6342501055554854,   400939.4248340616,  0.015908660133237804 } },       
    {  2459725.925246734, {   19.48072787262379, -2.8845065474685128,  392494.79881497874,  0.016250968843356913 } },       
    { 2459521.6298222425, {   196.6579853192581,  3.7324788496706987,   365800.6317095171,  0.017436993458875703 } },       
    {   2457665.56476052, {  224.75420192148908,   4.613246023213594,  406024.83417547937,   0.01570938969444856 } },       
    {  2453906.926883445, {  22.961665485757518,  1.9574685218627927,   372785.9927473855,    0.0171102223396932 } },       
    { 2456700.6844779793, {   112.6591963702925,  -4.975589967800055,  406234.32422928634,   0.01570128788907858 } },       
    {  2452406.927536222, {  51.272942630415244, -2.3466150618166184,  396794.34981297236,  0.016074862703574735 } },       
    {  2457012.604115998, {  256.42692706563315,    4.35598309007935,    373203.466864144,   0.01709108058037593 } },       
    {  2456262.648551683, {    96.7518148364324,  -3.447633230189316,   404588.1500932373,   0.01576517802338375 } },       
    {  2453824.663742186, {   19.53130746718017,   1.388875659641162,   362286.3459306062,   0.01760615489934374 } },       
    {  2453291.036365227, {  179.62354727172087,   2.836703812342603,  382155.14496467466,  0.016690698084464335 } },       
    {  2453853.157831423, {  35.021336573462804,  2.6807452043216395,   367180.5645534421,  0.017371455389816458 } },       
    { 2455876.6858620266, {   52.14926977672405,  1.9801551957976204,  403832.57703632396,  0.015794677212282955 } },       
    {  2458183.763278761, {   219.1678653365976,  5.1931965938319955,   389093.9173576854,   0.01639302336007676 } },       
    { 2457570.5920485347, {  54.202136453979264,  -4.729897887573367,  366000.51250161475,    0.0174274697753436 } },
    {  2455625.981486084, {  351.24671272883677,   4.950033060679646,   406338.5842145311,  0.015697258858625933 } },
    { 2454601.7878137575, {   181.6026588443318,  -3.117497968644145,   396749.0435609729,   0.01607669851021385 } },       
    { 2459055.8928899015, {  184.50012336716898,   5.162489211924248,   368371.5120083447,  0.017315287740813208 } },       
    { 2451753.5675923247, {   82.66418840816155, -2.8049629190243004,    362791.597172753,  0.017581632696978357 } },       
    {   2453238.89733255, {  212.75459724845305, 0.13429379090921348,  378415.05002711655,   0.01685567746108276 } },       
    {  2452357.719895975, {   120.0259010414709,  3.1487457040151297,   370926.5688905136,  0.017196002887031794 } },       
    { 2459833.5887556397, {   357.2559293416962, -3.7577257055362008,  371702.47013963416,   0.01716010398304715 } },       
    {  2453367.752164485, {  114.45999491218349,  5.0014196028011275,  406418.72324364254,  0.015694163365444488 } },       
    {  2457443.366960138, {  179.05185843751482,  0.6726063973802492,  403051.65681776765,   0.01582528225099609 } },
  };

  for (const auto& [jde, expected] : dataset) {
    const auto& [λ, β, r] = apparent(jde);
    ASSERT_NEAR(λ.deg(),    std::get<0>(expected), 5e-7);
    ASSERT_NEAR(β.deg(),    std::get<1>(expected), 1e-11);
    ASSERT_NEAR(r.km(),     std::get<2>(expected), 1e-7);

    const auto ppi = equatorial_horizontal_parallax({ λ, β, r });
    ASSERT_NEAR(ppi.rad(),  std::get<3>(expected), 1e-14);
  }
}


} // namespace astro::moon::test
