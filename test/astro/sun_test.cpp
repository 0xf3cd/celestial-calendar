#include <gtest/gtest.h>
#include "util.hpp"
#include "astro.hpp"

namespace astro::sun::geocentric_coord {

TEST(Sun, vsop87d_geocentric_position) {
  const std::unordered_map<double, std::tuple<double, double, double>> EXPECTED {
    // JD                   Longitude            Latitude                Radius
    { 2422498.7094451743, {  91.40761280128208, -0.00010445464204317034,  1.016482372497581 } },
    { 2424086.2753223246, {  214.0784992176159,   9.025877737323859e-05, 0.9933810056281362 } },
    {  2426307.814908547, {   244.349264641809, -0.00014177197935992398, 0.9866295822233015 } },
    {  2426515.531939514, {  90.61430645870496,  2.3256322621339876e-05, 1.0163985079768287 } },
    {  2429413.791377101, {   67.9863456016501, -2.0378838134732623e-06, 1.0137769465798958 } },
    {  2429932.669185936, {  216.5943769679252,   6.671158580438115e-05, 0.9928061998304796 } },
    { 2431145.0882131555, {  334.8647689862846, -0.00013991477829522334, 0.9897551747483088 } },
    {  2433114.205346291, { 113.80136999466049,   3.734323296032658e-05, 1.0163673209471755 } },
    { 2435423.6241004425, { 228.94734202513246, -0.00018930526573649798, 0.9898494008800276 } },
    { 2437166.0289001414, { 146.51795881944236, -0.00012191084854112845, 1.0118911482693451 } },
    {  2437696.654992456, { 311.81268641068164,  0.00012266300336438043, 0.9853954458300703 } },
    {  2438329.370005227, { 212.72664542867096,  -7.644324484841227e-05, 0.9939334498929627 } },
    {  2439201.921385435, { 356.37262649150216, -0.00015819394230176997, 0.9951695819636491 } },
    {  2440682.090759139, { 15.379226720720908,  6.6020134271151145e-06, 1.0006253106775171 } },
    {  2442499.726963114, { 6.9176332448569156, -0.00016685606299194443, 0.9980166182452426 } },
    { 2443353.3628917965, { 125.64130854820087,   6.023139130184266e-05, 1.0152737155492926 } },
    {          2445701.1, {  280.3662619392999,  1.3856637992645944e-05, 0.9832889892830442 } },
    { 2446504.0088107465, { 353.62865640403743,  -2.900567878065357e-06, 0.9942989551073447 } },
    { 2446577.5465449314, {  65.47703929502222, -0.00014564941224789462,  1.013182356911367 } },
    { 2447576.2639734284, {  330.0864627873243,  0.00017073962293748948, 0.9885175150043095 } },
    { 2448469.2780215773, { 128.06019670616706,   0.0002734851917318931, 1.0150342302738444 } },
    { 2448852.9579589106, {  145.7399433825858,   0.0002528751702638316, 1.0120729111821587 } },
    { 2449142.6811706414, {  73.56887253952118, -0.00011987917136891878,  1.014482032010702 } },
    { 2449171.2071517673, {  100.8082066960319,  -3.063769183646984e-05, 1.0166578922188918 } },
    { 2450100.2217416503, { 296.88143069333046,  0.00016324146076764345, 0.9837606066844959 } },
    { 2450287.8415668644, { 120.75512121743282,   3.112427193310336e-05, 1.0158969043639177 } },
    {  2450909.878261393, {  16.37391905719278, -0.00011751861826115203,  1.000685724707239 } },
    {          2451545.0, {  280.3778436711984,  0.00022721051444223787, 0.9833276819105508 } },
    { 2452167.9919785303, { 172.71213885144016,    8.58305925081789e-05, 1.0055583072427878 } },
    {  2452667.874019259, {  308.0219862282179,   4.828783378313235e-05, 0.9848201393143594 } },
    {          2454359.1, { 172.37619608369778, -0.00010725756446863268, 1.0057018016353796 } },
    {      2454774.36215, {  221.8062247735661, -0.00010196625102869854,  0.991769848723092 } },
    {  2456006.483713451, { 359.76716350062634,  0.00018088088780852807, 0.9958951194359904 } },
    {  2456197.878699211, { 184.66572850621924,  0.00011650695594193149, 1.0021584608444742 } },
    { 2457537.7818204714, {  68.33551115375212,   2.563500435533221e-05, 1.0136372634218618 } },
    {         2460505.25, { 111.82761866574583,  -3.226703118214394e-05, 1.0165107642588653 } },
    {  2460836.080832412, {  78.99028058423755, -0.00024147436141018486, 1.0150929666063702 } },
    { 2461085.3885344816, {  325.1822727842846, -0.00013927818849594653, 0.9874798461176946 } },
    {      2462597.96105, {   16.6987939374485,  3.1791715908057304e-05, 1.0006923288119707 } },
    {          2464080.5, {  37.80127186208301, -0.00012100241309577134, 1.0065840587631982 } },
    {  2466064.980637341, {  190.1348974931425, -2.2160987210892465e-05, 1.0006955308706567 } },
    { 2466506.4625236494, { 266.63979731133804,   3.160521105915074e-05, 0.9839816447383247 } },
    { 2467097.6714326707, {  129.0833346295749, -0.00016011067182241498, 1.0149877242764334 } },
    { 2467870.4651872576, {   169.854862338183,   9.019908739678918e-05, 1.0064928580579036 } },
    { 2468230.0971195456, { 164.40494450820188,   9.484253600470152e-05, 1.0079610915062702 } },
    {  2470316.113402216, {  63.41572414241455,   4.153004775904214e-06, 1.0125671295277887 } },
    { 2472295.7218903233, {  211.5400448470864, -0.00017103450715029174, 0.9946695754070166 } },
    { 2472805.1941494658, { 357.33856789306446,  -0.0001209631157391228, 0.9949577836621696 } },
    { 2473298.1783402613, { 120.86695813537881, -0.00022483345442623527,  1.015928709958868 } },
    {  2474768.039980193, { 129.36432429400156, -5.5048635748783945e-05, 1.0150292693157028 } },
    {   2475777.60958692, {  46.88954255896533,  -0.0001969276319538511, 1.0088076505510342 } },
    {   2475849.66130982, { 115.89283513734699,   9.649638103360313e-05, 1.0163381010527106 } },
    {  2476760.638036946, {  294.5303344681015,  -0.0001281520706875935, 0.9835701553139514 } },
    {   2477050.98026629, {  218.6364705211381,  -7.532502960022323e-05, 0.9928449372369779 } },
    {  2477774.153057321, { 211.34065294786706,  0.00019950598081359435, 0.9948560492094519 } },
    { 2479899.4335036613, { 146.63292392087533,   9.235303590663892e-05, 1.0122101442683784 } },
    {    2481023.2545819, { 173.82757046144616,  3.1232970114378357e-06, 1.0056313745024836 } },
  };

  for (const auto& [jd, expected] : EXPECTED) {
    const auto& [λ, β, r] = vsop87d(jd);
    ASSERT_NEAR(λ.as<DEG>(), std::get<0>(expected), 1e-11);
    ASSERT_NEAR(β.as<DEG>(), std::get<1>(expected), 1e-15);
    ASSERT_NEAR(r,           std::get<2>(expected), 1e-15);
  }
}


TEST(Sun, fk5_correction) {
  const std::unordered_map<double, std::tuple<double, double>> EXPECTED {
    // JD                   Longitude Delta           Latitude Delta
    { 2421614.0856030583, { -2.5091672396119975e-05,  1.4918431407582651e-05 } },
    {  2421684.594562597, {  -2.509169056399565e-05,    8.44835580279257e-06 } },
    { 2424710.3919103565, { -2.5091645573671216e-05, -1.4132302958508211e-05 } },
    {  2424873.541727225, {  -2.509167967051071e-05,  1.1340427261861204e-05 } },
    {  2425074.217328695, {  -2.509165267337155e-05,  -1.398352060246548e-05 } },
    { 2425367.1368461107, {  -2.509165566107493e-05,  1.0656874192085046e-06 } },
    {  2426631.186830581, { -2.5091604008833442e-05,  -5.686700521800123e-06 } },
    {  2427343.331375714, { -2.5091648367173722e-05,  -9.852184380369391e-06 } },
    {  2427860.771517319, { -2.5091685321889784e-05,    1.40916447100312e-05 } },
    {  2428309.240384667, {  -2.509165537318986e-05,  -4.083702617292931e-06 } },
    {  2429003.053763827, {  -2.509168682002803e-05,   5.312211351856427e-06 } },
    { 2429912.8164144373, { -2.5091708591318916e-05,  -7.060307212494396e-06 } },
    { 2430765.0760874804, { -2.5091671061778134e-05,  1.5306111015214236e-05 } },
    { 2431112.7481521517, {  -2.509167118089459e-05,   1.504195212395463e-05 } },
    { 2431656.3855597437, { -2.5091661222719588e-05,  -1.467705396286126e-05 } },
    { 2431896.2510702685, { -2.5091642990364776e-05,  1.1555387854478738e-05 } },
    { 2431960.4120500633, { -2.5091695832214674e-05, -3.7343665168863665e-06 } },
    {  2432187.501465682, {  -2.509166408358585e-05,  1.2828247000576642e-05 } },
    { 2432561.7475197767, { -2.5091655623827022e-05,  1.4016146225359127e-05 } },
    { 2432622.9095498673, { -2.5091668295538596e-05,   1.220875718902373e-05 } },
    {   2432952.67863299, { -2.5091666501973706e-05,    1.53761556718949e-05 } },
    { 2432963.4046238316, { -2.5091661462071593e-05,    1.50119179485994e-05 } },
    {  2432978.259194849, {  -2.509166523131607e-05,   1.363692600460224e-05 } },
    { 2433637.7266294826, {  -2.509168366820641e-05,  1.0969817625570484e-05 } },
    {  2434143.986544536, {  -2.509173638121715e-05,  -1.709013870447407e-06 } },
    { 2434847.4417601665, {  -2.509169881137445e-05,   5.243013404543969e-06 } },
    { 2435096.1180057405, { -2.5091645172482226e-05,  1.0453027212064407e-05 } },
    { 2435294.2574811466, { -2.5091660962280948e-05, -1.3125013585099277e-05 } },
    {  2436577.605689057, { -2.5091682953649794e-05,  1.3786201594773088e-05 } },
    {   2437450.09999954, {  -2.509163763604439e-05,   -6.37153433425873e-06 } },
    {  2437591.734968175, { -2.5091667483962746e-05,  -4.971952112954651e-06 } },
    {  2437625.586337221, { -2.5091623600080527e-05,    4.00119135936683e-06 } },
    {  2437730.665990756, {  -2.509168144969865e-05,  1.3096616499647817e-05 } },
    {  2438021.258862965, { -2.5091704374702903e-05,  1.1056545449440596e-05 } },
    { 2439066.1105002053, {  -2.509159826533511e-05,   -1.48649498953714e-06 } },
    {  2440681.177043535, { -2.5091672833311707e-05,   7.716216777645776e-06 } },
    { 2440922.9522058275, { -2.5091671258872936e-05,   6.564504648032194e-06 } },
    { 2441252.4222598327, {  -2.509165953653771e-05,  -2.875078588264955e-06 } },
    {   2442211.44629896, { -2.5091618779506815e-05,  -9.241798850947591e-06 } },
    {  2443893.121392499, { -2.5091675156608817e-05,  1.4804807693946662e-05 } },
    {  2444649.764626117, { -2.5091673186610508e-05,  1.5113428546753872e-05 } },
    { 2450545.2710530814, { -2.5091650854603798e-05,   7.213589216743213e-06 } },
    { 2453418.9434938473, {   -2.50916573623715e-05,  1.4939130729846946e-05 } },
    {  2453521.813336163, {  -2.509168398032785e-05,  -6.472307008403232e-06 } },
    {  2456286.921275987, { -2.5091673320983927e-05,  1.1583180446610042e-05 } },
    { 2457827.5440197964, { -2.5091662433834905e-05,   1.188700541394534e-05 } },
    {  2458273.764966161, { -2.5091683476773015e-05,  -7.305007244492261e-06 } },
    {  2459807.383258806, {  -2.509166626512775e-05, -1.5244309233065666e-05 } },
    { 2460359.8039363744, { -2.5091657811663905e-05,  1.4873256076322387e-05 } },
    { 2461615.6237278646, { -2.5091661678038083e-05, -1.5169088273552501e-05 } },
    { 2461657.7333513405, { -2.5091652022223154e-05, -1.3192554421529269e-05 } },
    { 2463130.5081410077, { -2.5091671001640005e-05, -1.1360740800301972e-05 } },
    { 2464989.4147874974, {   -2.50916920635382e-05,  -4.091253013316177e-06 } },
    { 2466096.8201232953, { -2.5091689266117554e-05,  -1.020987951467883e-06 } },
    {  2466729.484619301, { -2.5091661238073808e-05, -1.5180671588320268e-05 } },
    { 2467001.8240119503, { -2.5091642173314427e-05,   2.244008793267106e-06 } },
    { 2467594.7747756597, {  -2.509168022247438e-05,    8.48644875837031e-06 } },
    {   2467963.79499122, {  -2.509163354797471e-05,   9.323468425658358e-06 } },
    { 2468130.7321785376, {  -2.509168913811568e-05,   -6.16013082649317e-06 } },
    {  2468705.886389889, { -2.5091649552188062e-05,  1.1625950451483924e-05 } },
    {  2470292.538419142, { -2.5091638783967227e-05,  1.3607418929926539e-06 } },
    {  2471253.336368543, { -2.5091665960985306e-05,   9.802434807398191e-06 } },
    {  2472324.916086494, { -2.5091615823033566e-05,   3.992327206952477e-06 } },
    {  2474703.734096592, { -2.5091607741389688e-05,  -5.777645193275354e-06 } },
    { 2475531.0198328616, { -2.5091655060505792e-05, -1.3976239721042982e-05 } },
    { 2476854.0845395336, {  -2.509162103433187e-05,   4.705717806470753e-06 } },
    {  2478360.847359197, {  -2.509171739453048e-05,  -6.844634103157941e-06 } },
    {  2479012.605710678, {  -2.509169285314586e-05,  1.1854577644480588e-05 } },
    { 2479578.2313445043, {   -2.50916825448432e-05,  -9.179087557644382e-06 } },
    { 2480048.7002244527, { -2.5091656457391932e-05,   1.439408587258693e-05 } },
    {  2421943.190803039, { -2.5091670934406595e-05,   9.690757271687223e-06 } },
    {  2422880.207353781, {  -2.509168258636536e-05, -1.3706984593381813e-05 } },
    { 2424398.9561459045, { -2.5091645294107853e-05, -1.3533317749628003e-05 } },
    {  2425847.029717303, {   -2.50916536173894e-05, -1.4797024069345518e-05 } },
    { 2428391.6168062873, { -2.5091668224046786e-05, -1.5343634305315946e-05 } },
    {  2430609.107017416, { -2.5091652339607853e-05, -1.3432784019414807e-05 } },
    { 2431179.7779708765, { -2.5091703377933593e-05,   8.772119956147027e-06 } },
    { 2431351.5256792065, { -2.5091705522160158e-05,  -1.165356817539354e-05 } },
    { 2432203.2741505075, {  -2.509167486812942e-05,   1.467710373278058e-05 } },
    { 2432250.6320899613, { -2.5091638218171112e-05,  1.3260727307094874e-05 } },
    { 2433477.6941603646, {  -2.509164230281206e-05, -1.4245929851168312e-05 } },
    { 2433665.0459526572, {   -2.50916716274993e-05,  1.4736493494527285e-05 } },
    { 2433749.2858511163, { -2.5091638249536743e-05,  5.8271805162824016e-06 } },
    {  2434309.316239123, {  -2.509166239848645e-05, -3.7208076070844553e-06 } },
    { 2437043.7977593583, { -2.5091644639970003e-05,  4.0360365778880454e-06 } },
    { 2437277.4221911924, { -2.5091642944844992e-05,   8.241513890403573e-06 } },
    {  2438515.780877586, {  -2.509165263319108e-05,  1.2190864452215577e-06 } },
    { 2440151.0198625997, { -2.5091677179388455e-05,  -4.339411589967165e-06 } },
    {  2440188.064899745, {  -2.509165223692049e-05,    5.46937587360887e-06 } },
    { 2440354.6908233003, { -2.5091687986947303e-05,  -2.054082572300223e-06 } },
    { 2440696.8673751387, { -2.5091708679797165e-05,   3.909067845503418e-06 } },
    { 2441214.7566042724, { -2.5091628927491084e-05, -1.1426707844445173e-05 } },
    {  2442097.224119589, { -2.5091667009100866e-05,  1.4856400865227043e-05 } },
    {  2442133.919596853, { -2.5091659877111992e-05,   9.529570027915305e-06 } },
    {  2443155.391302985, { -2.5091660665646174e-05,  1.4148377343102153e-05 } },
    {   2443226.66274259, { -2.5091691825577858e-05,  1.0148962446446684e-05 } },
    {  2443555.740620342, {  -2.509167278622628e-05,   1.501819388717582e-05 } },
    {  2443747.956309117, { -2.5091650957394983e-05, -1.4534674750785998e-05 } },
    {  2443907.008424264, {  -2.509166640373145e-05,  1.5377148139166317e-05 } },
    {  2444123.383721766, { -2.5091656849812224e-05,  -1.345922439442691e-05 } },
    {          2445701.1, {  -2.509166876912175e-05,  1.2691582252687651e-05 } },
    { 2445728.4671206907, {  -2.509166608590702e-05,  1.5283319447805687e-05 } },
    {    2446513.9825043, { -2.5091647748143793e-05,   1.014596266350623e-05 } },
    {  2447218.565686262, { -2.5091643197133864e-05,  1.4176503662332723e-05 } },
    {  2450131.995148659, {  -2.509165438525031e-05,  1.4915532219383775e-05 } },
    { 2450278.0228070086, { -2.5091683593417113e-05, -1.4100256136022047e-05 } },
    {  2450769.839627534, { -2.5091595190071878e-05,  2.6839006547672724e-06 } },
    {          2451545.0, { -2.5091701327034256e-05,  1.2659340091545764e-05 } },
    {  2452067.265355629, { -2.5091683687438373e-05,   -7.94267578186759e-06 } },
    {  2452836.877042457, { -2.5091686232553144e-05, -1.4303039507813188e-05 } },
    {  2453262.454052536, { -2.5091684969639857e-05,  -1.238001468784882e-05 } },
    {  2453752.466975442, { -2.5091674995887547e-05,  1.4597975314902689e-05 } },
    {          2454359.1, {  -2.509164922805946e-05,  -1.224228034168364e-05 } },
    {  2454370.882902501, { -2.5091693773764956e-05, -1.0135960845911731e-05 } },
    {  2454734.943571639, { -2.5091675318367864e-05, -1.0371097737361178e-05 } },
    {      2454774.36215, { -2.5091639335341813e-05,  -8.901717162042233e-07 } },
    { 2455814.4174690833, { -2.5091684334907437e-05, -1.3086274124426329e-05 } },
    {  2457012.236219827, { -2.5091676620734035e-05,  1.0598562561317496e-05 } },
    {  2457078.775734441, {  -2.509168222200492e-05,  1.4349891304699554e-05 } },
    {         2460505.25, { -2.5091670123309776e-05, -1.4105976299516633e-05 } },
    { 2461134.6179472343, {  -2.509170384390839e-05,   7.926166358363559e-06 } },
    { 2462304.4085584246, {  -2.509169533346633e-05, -1.0013478112634048e-05 } },
    {      2462597.96105, {  -2.509165918119969e-05,   7.393166730594901e-06 } },
    {  2463042.152194445, {  -2.509168247388572e-05, -1.1345230492137918e-05 } },
    {  2463112.334247066, {   -2.50916829831069e-05, -1.3973636777055276e-05 } },
    {          2464080.5, {  -2.509169886364834e-05,   2.055381311138417e-06 } },
    { 2464745.5141219306, { -2.5091650057814317e-05,  1.4675725216587742e-05 } },
    { 2466591.5583286528, {  -2.509165951613045e-05,  1.2242158543454951e-05 } },
    { 2467032.4364133934, { -2.5091658344737657e-05,    -5.5585944446831e-06 } },
    { 2467218.2684583645, { -2.5091736363778734e-05,   5.779573357906499e-06 } },
    {  2467659.003065149, { -2.5091661900734886e-05,    1.52019354916234e-05 } },
    { 2471580.3970652344, {  -2.509164581293268e-05,  2.5206138634316666e-07 } },
    {  2471849.405585389, {  -2.509166462853145e-05,  -1.535871209851388e-05 } },
    {  2474264.852218124, { -2.5091637578281973e-05,  1.1755289285677918e-05 } },
    { 2474702.1872755736, { -2.5091605993791718e-05,   -5.40614455481631e-06 } },
    {   2477211.66049584, { -2.5091668168587273e-05,   6.583799438136177e-06 } },
    {  2481289.841332455, { -2.5091638785758214e-05,  -8.395244169099233e-06 } },
  };

  for (const auto& [jd, expected] : EXPECTED) {
    const auto vsop_result = vsop87d(jd); // Sun's geocentric position.
    const auto& [Δλ, Δβ] = fk5_correction(jd, vsop_result);
    ASSERT_NEAR(Δλ.as<DEG>(), std::get<0>(expected), 1e-20);
    ASSERT_NEAR(Δβ.as<DEG>(), std::get<1>(expected), 1e-17);
  }
}

}
