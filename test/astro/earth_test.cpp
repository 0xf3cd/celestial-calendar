#include <gtest/gtest.h>
#include "random.hpp"
#include "julian_day.hpp"
#include "earth.hpp"

namespace astro::earth::heliocentric_coord {

TEST(Earth, vsop87d) {
  // Data was obtained from PyMeeus (https://pypi.org/project/PyMeeus/).
  // PyMeeus is a well-implemented Python library for astronomical calculations.
  //
  // The values are directly obtained thru `Earth.geometric_heliocentric_position(Epoch(jd), tofk5=False)`.
  const std::unordered_map<double, std::tuple<double, double, double>> EXPECTED {
    // JD                   Longitude            Latitude                 Radius
    { 2421716.1296036816, { 221.38657723739743,  -4.115227525758551e-05,  1.008090463912895 } },
    { 2422912.8711762577, {  318.1285136051265,  -9.914852042583953e-05,  1.013311807340686 } },
    {   2423642.07626529, { 316.90183977950437,  0.00018984242102971176,  1.013629026593831 } },
    { 2427762.3503392735, {  57.84172705583478, -0.00017592199121776775, 0.9877914715417111 } },
    { 2428967.4165794663, { 168.68654853142652,   6.849943365057851e-05, 0.9931652143755128 } },
    {  2431358.495909215, { 1.8011797502658737,  -0.0001487557951324536,  1.002675351782843 } },
    { 2433182.0229792064, {  359.1684329106647,   6.520403975641616e-06, 1.0034974111802424 } },
    {  2434764.074295689, { 121.00089581218708,  1.1184064082808447e-05, 0.9841389122462156 } },
    { 2435046.7593623144, {  37.29331147589983,   4.222944321901619e-05, 0.9927090169815312 } },
    { 2439481.5212830557, {  89.71342393841405,  0.00013053205103552307, 0.9836791734809575 } },
    { 2440655.2477869145, { 168.75488886400126,  -5.764773170807808e-05,  0.993104457802697 } },
    { 2441797.7565915985, { 214.90030085108992, -0.00016581065782778222, 1.0061580960390424 } },
    { 2444102.1760774567, { 323.20459785160074,   0.0002027188990128626,  1.012575439888013 } },
    {  2444952.569889879, {  81.98730565310416,   4.047485501149525e-05, 0.9842983319531176 } },
    {          2445701.1, { 100.36626193929987, -1.3856637992645944e-05, 0.9832889892830442 } },
    {          2451545.0, { 100.37784367119836, -0.00022721051444223787, 0.9833276819105508 } },
    {          2454359.1, {  352.3761960836978,  0.00010725756446863268, 1.0057018016353796 } },
    {      2454774.36215, {   41.8062247735661,  0.00010196625102869854,  0.991769848723092 } },
    { 2454999.9655851964, { 266.39729632727995, -0.00013599830496268542,  1.015983142942533 } },
    {   2455388.84525163, { 288.94440860623035,  -4.980835488833103e-05,  1.016634587783607 } },
    { 2455914.4367720224, {  86.64757585498046,   5.131624130677439e-05, 0.9839735760324848 } },
    {  2456143.345232291, {   311.879423569615,  -6.730536081341476e-05, 1.0145537359065666 } },
    {  2458188.101095128, { 169.96610473337842,   -9.87338662803703e-05, 0.9931937387596217 } },
    {         2460505.25, { 291.82761866574583,   3.226703118214394e-05, 1.0165107642588653 } },
    {  2461494.483947319, { 189.05186432152368,  0.00012459973264808085,    0.9984558144491 } },
    {      2462597.96105, {  196.6987939374485, -3.1791715908057304e-05, 1.0006923288119707 } },
    { 2463634.3736982383, { 137.38066537538543,   0.0001610434589814602, 0.9860327068303001 } },
    {          2464080.5, {   217.801271862083,  0.00012100241309577134, 1.0065840587631982 } },
    {  2467045.736127866, {  259.5121907287303,  0.00016932117371819497,  1.015164815553697 } },
    {  2468356.479543585, {  110.8878258386103,  -1.479518960106849e-05,  0.983468272403578 } },
    { 2469150.4664363284, { 175.04847168099514, -0.00014129726815689347, 0.9944371569907081 } },
    {  2469266.635945361, { 287.61533414099904,   -9.56689246254318e-06, 1.0166829268123343 } },
    {   2470210.48592792, {  139.1445159854884,  -0.0001577964866666292, 0.9863022963251856 } },
    {  2470800.744066477, {  357.9910055541477,   9.838834579594222e-05, 1.0042919301532383 } },
    { 2474291.9953455296, { 202.87187222890134, -0.00017024632115228845, 1.0023192805324896 } },
    {  2475915.780080406, {  359.6033330549981,  0.00010299206401811968, 1.0039472643099783 } },
    { 2479702.9079045844, { 135.20872608030186,  -8.875324753265642e-05,  0.985635590335806 } },
  };

  for (const auto& [jd, expected] : EXPECTED) {
    const auto& [λ, β, r] = vsop87d(jd);
    ASSERT_NEAR(λ.as<DEG>(), std::get<0>(expected), 1e-10);
    ASSERT_NEAR(β.as<DEG>(), std::get<1>(expected), 1e-10);
    ASSERT_NEAR(r,           std::get<2>(expected), 1e-10);
  }
}


TEST(Earth, to_fk5) {
  // Data was obtained from PyMeeus (https://pypi.org/project/PyMeeus/).
  // PyMeeus is a well-implemented Python library for astronomical calculations.
  //
  // The values are directly obtained thru `Earth.geometric_heliocentric_position(Epoch(jd), tofk5=True)`.
  const std::unordered_map<double, std::tuple<double, double, double>> EXPECTED {
    // JD                   Longitude            Latitude                 Radius
    {  2422870.449393379, {  277.5991944820925,   6.271509802083991e-05, 1.0167054034668424 } },
    { 2433803.1179065835, { 254.13801685314476, -0.00021475443373610516, 1.0147359416997446 } },
    { 2433969.0308137564, {  55.37135499203906, -0.00026914283593615677, 0.9883780203263757 } },
    {  2434010.885990978, {  97.87151521966916,  -5.218780579918562e-06,  0.983347309820392 } },
    { 2434117.7582667386, { 205.22174140783295,  0.00025664099088641706, 1.0034974825092837 } },
    { 2434707.7544034696, {  63.69777457166141,  -3.597349520888408e-05, 0.9867852422564513 } },
    {  2438334.167581346, {  37.51731317099257,  0.00013586846986909652, 0.9926401774115884 } },
    { 2438349.6724430704, {  53.08387510318259, -0.00015498861963212073, 0.9889700194385979 } },
    {  2442036.491969781, {  87.94958017680223,   0.0002543655674688898, 0.9838186144804597 } },
    {  2445238.742760162, {  2.828802266493587,  1.4567449341834094e-06, 1.0025650981924552 } },
    {          2445701.1, {  100.3662368476311,   -2.65482202453336e-05, 0.9832889892830442 } },
    { 2449608.2183569474, {    349.71303409581, -0.00010706646969814567,  1.006312727151683 } },
    {  2450901.280688693, {  187.8904308638361,  0.00014081018596194403, 0.9982600208370311 } },
    {          2451545.0, { 100.37781857949703, -0.00023986985453378364, 0.9833276819105508 } },
    { 2452773.6009372026, { 232.91433302242714,  -9.016196608895975e-05, 1.0105358839855594 } },
    {          2454359.1, { 352.37617099204857,  0.00011949984481031631, 1.0057018016353796 } },
    { 2454430.7401734386, {  63.57971148129021, -0.00016881285492618213, 0.9869430557071225 } },
    {  2454477.928464429, { 111.58149571822374, -2.9217871656254437e-05, 0.9834620392105351 } },
    {      2454774.36215, {  41.80619968192676,  0.00010285642274490276,  0.991769848723092 } },
    {  2456599.012775541, {  40.24284067577016,  0.00013233336848623577, 0.9922095878519285 } },
    {         2460505.25, {  291.8275935740757,  4.6373007481660566e-05, 1.0165107642588653 } },
    {  2462253.797606135, { 217.31798759072095,  0.00014356306327725063, 1.0065230335903295 } },
    {      2462597.96105, { 196.69876884578932,   -3.91848826386522e-05, 1.0006923288119707 } },
    {  2462803.048314055, {  35.15947395169138,   5.549310960355641e-05, 0.9936119937422043 } },
    {          2464080.5, { 217.80124677038415,  0.00011894703178463292, 1.0065840587631982 } },
    {  2465818.208106549, {  129.6424479036376,  0.00021863046598274077, 0.9849663124381629 } },
    { 2465955.6124134227, { 264.86611530357004,   4.790717704574079e-05, 1.0157877997793923 } },
    {  2467883.960993748, {  3.034191497798926,  0.00022324659956356175, 1.0028378695871558 } },
    { 2468579.6359090433, {  329.2323119557751,  -0.0001959493022179561,  1.011560779647243 } },
    {  2471874.701906761, {  336.8449853133812,   -0.000157048980712365, 1.0098971830764119 } },
    {  2472244.043719958, {  340.8055941159433,  3.6708399245127127e-05, 1.0089276517786046 } },
    { 2472428.9541814863, { 166.36409926596085,  0.00025369265349397093, 0.9920838089830679 } },
    { 2473803.1389356623, {  78.32198269771197, -0.00019996853880537534, 0.9848847621021174 } },
    { 2474250.8374518882, { 162.02004643642454,  0.00011285878622013785,  0.990962301594709 } },
    { 2475447.4677739907, {  260.6373121191759,  0.00020781447306022227,  1.015264130629245 } },
    {   2476577.45526173, { 293.32805785553916,  -8.991646388985693e-05, 1.0164371426768366 } },
    {  2478179.388263417, {  71.55599872021608,  2.8731269931773263e-05, 0.9858736561713404 } },
  };

  for (const auto& [jd, expected] : EXPECTED) {
    const auto vsop_result = vsop87d(jd);
    const auto& [λ, β, r] = to_fk5(jd, vsop_result);
    ASSERT_NEAR(λ.as<DEG>(), std::get<0>(expected), 1e-10);
    ASSERT_NEAR(β.as<DEG>(), std::get<1>(expected), 1e-10);
    ASSERT_NEAR(r,           std::get<2>(expected), 1e-10);
  }
}

}
